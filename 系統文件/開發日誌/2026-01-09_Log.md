# MarkdownToDocx 開發對話紀錄 (Vibe Coding Session Log)
**日期**: 2026-01-09
**專案**: MarkdownToDocx (專業級 Markdown 轉 Word 工具)
**目標**: 系統架構重構 (Modularization) 與功能優化 (Live Preview)

本文件記錄了 User (開發者) 與 AI (Antigravity) 之間的協作歷程，重點在於針對系統長遠維護性的架構調整，以及響應使用者需求恢復並增強預覽功能。

---

## 1. 系統架構重構 (Refactoring)
*   **User指令**: 希望對目前系統功能提出建議。
*   **AI建議**: 提出模組化、i18n 與即時預覽等建議。User 同意優先執行模組化。
*   **AI行動**: 
    1.  **建立 `core/` 套件**: 將業務邏輯從 `app.py` 分離。
    2.  **拆分 `converter.py`**: 封裝 `process_mermaid_to_local_img` 與 `convert_md_to_docx`。
    3.  **拆分 `style_analyzer.py`**: 封裝 `get_docx_style_info`。
    4.  **相依性管理**: 更新 `requirements.txt` 加入 `pandas` (用於樣式分析)。
*   **Vibe特徵**: **Clean Code**。將 400+ 行的 `app.py` 瘦身，使職責分離 (Separation of Concerns)，提升可讀性與可測試性。

## 2. 即時預覽功能回歸 (Live Preview Restoration)
*   **User指令**: 「及時預覽功能之前有做好了，只是後來拿掉而已...除非你能把功能改為上傳多個檔案後能把她們依順序接在一起來預覽」。
*   **AI行動**:
    1.  **合併預覽邏輯**: 在 `app.py` 中實作邏輯，讀取所有上傳檔案 (依排序後順序)。
    2.  **內容串接**: 將各檔案內容以 Markdown 分隔線 (`---`) 連接，並標註檔名。
    3.  **IO 指標重置**: 確保讀取預覽後執行 `f.seek(0)`，避免影響後續的轉換流程。
    4.  **UI 呈現**: 使用 `st.expander` 包裝，預設摺疊以保持介面整潔。
*   **Vibe特徵**: User-Centric Design。快速回應使用者對於「多檔預覽」的具體痛點，提供直觀的解決方案。

## 3. 文件更新 (Documentation)
*   **User指令**: `doc-update`
*   **AI行動**: 
    1.  更新 `README.md` 專案結構說明。
    2.  更新 `系統文件/此文件清單.md` 與 `操作手冊.md`。

---

## 總結 (Summary)
本次 Session 提升了專案的工程品質 (Engineering Quality) 與使用者體驗 (UX)。
1.  **架構面**: 完成核心與 UI 的分離，為未來功能擴展打好地基。
2.  **功能面**: 重新實現了更強大的「合併預覽」功能。
3.  **待處理**: 
    -   多語系支援 (i18n)。
    -   離線圖表渲染備援機制。

**關鍵代碼變更檔**:
- `core/converter.py` [NEW]
- `core/style_analyzer.py` [NEW]
- `app.py` [MODIFIED]
- `requirements.txt` [MODIFIED]

---

## 🧠 經驗資產與決策 (ADR & Lessons)

**🔸 [ADR] 架構模組化 (Modularization)**
*   **背景：** `app.py` 隨著功能增加已達 400+ 行，介面程式碼與核心邏輯 (Pandoc 呼叫、Regex 解析) 混雜，難以維護與擴充。
*   **決策：** 採納「關注點分離 (Separation of Concerns)」原則，將核心邏輯抽取至 `core/` 目錄下。`app.py` 僅保留 Streamlit UI 與互動邏輯。
*   **原因：** 提升程式碼可讀性，且核心邏輯 (如轉檔函式) 未來可獨立於 UI 進行單元測試或被其他模組調用。

**🔸 [ADR] 合併預覽實作 (Merged Live Preview)**
*   **背景：** 使用者希望能確認多個檔案合併後的順序與內容，但舊版預覽僅針對單一檔案或功能被移除。
*   **決策：** 在使用者點擊「轉換」前，先讀取所有已排序的檔案內容，以 Markdown 分隔線串接後，透過 `st.expander` (預設摺疊) 顯示。
*   **原因：** 提供即時反饋 (Feedback Loop)，讓使用者在耗時的轉檔執行前能先修正排序錯誤。使用摺疊區塊避免過度佔用主畫面空間。

**🔸 [踩坑] Streamlit 檔案指標管理 (File Cursor)**
*   **情境：** 在實作「預覽」功能時，需要先讀取一次上傳的檔案內容來顯示。
*   **失敗/卡關原因：** Python 的檔案物件讀取後指標 (Cursor) 會停在檔尾。若未重置，後續的轉檔函式再次讀取時會讀到空內容。
*   **結論：** 在 Streamlit 中多次讀取 `UploadedFile` 物件時，務必在讀取後執行 `file.seek(0)` 重置指標，確保後續流程能正確獲取資料。
